<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transcriptor de Audios</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .upload-area {
        border: 2px dashed #007bff;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
      }
      .upload-area:hover {
        border-color: #0056b3;
        background-color: #e7f3ff;
      }
      .upload-area.dragover {
        border-color: #28a745;
        background-color: #d4edda;
      }
      .movistar-header {
        background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
        color: white;
        padding: 20px 0;
      }
      .result-card {
        margin-bottom: 20px;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .analysis-badge {
        margin: 2px;
      }
      .progress {
        height: 6px;
      }
      .loading-spinner {
        display: none;
      }
      .progress-container {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e9ecef;
      }
      .progress-bar {
        transition: width 0.3s ease;
      }
      .fw-bold {
        font-weight: 600 !important;
      }
      .progress-step {
        opacity: 0.7;
        transition: opacity 0.3s ease;
      }
      .progress-step.active {
        opacity: 1;
      }
      .step-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <header class="movistar-header">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1>
              <i class="fas fa-microphone-alt me-3"></i>Transcriptor de Audios
            </h1>
            <p class="mb-0">
              Transcribe las llamadas de audio de manera eficiente y precisa.
            </p>
          </div>
          <div class="col-md-4 text-end">
            <a href="/dashboard" class="btn btn-outline-light">
              <i class="fas fa-chart-bar me-2"></i>Dashboard
            </a>
          </div>
        </div>
      </div>
    </header>

    <div class="container mt-4">
      <div class="row">
        <div class="col-md-8 mx-auto">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-upload me-2"></i>Subir Archivos de Audio
              </h5>
            </div>
            <div class="card-body">
              <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                <h5>Arrastra y suelta tus archivos aquí</h5>
                <p class="text-muted">o haz clic para seleccionar archivos</p>
                <input
                  type="file"
                  id="fileInput"
                  multiple
                  accept=".wav,.mp3,.mp4,.avi,.mov,.flac,.m4a,.ogg,.webm"
                  class="d-none"
                />
                <div class="mt-3">
                  <small class="text-muted">
                    Formatos soportados: WAV, MP3, MP4, AVI, MOV, FLAC, M4A,
                    OGG, WEBM<br />
                    Tamaño máximo: 100MB por archivo
                  </small>
                </div>
              </div>

              <!-- Barras de progreso -->
              <div
                id="progressContainer"
                class="mt-4 progress-container"
                style="display: none"
              >
                <h6 class="mb-3 text-muted">
                  <i class="fas fa-cogs me-2"></i>Estado del proceso
                </h6>

                <!-- Progreso de subida -->
                <div id="uploadProgress" class="mb-4 progress-step">
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <span class="fw-bold text-primary">
                      <span class="step-icon bg-primary text-white">1</span>
                      Subiendo archivos...
                    </span>
                    <span id="uploadPercent" class="badge bg-primary">0%</span>
                  </div>
                  <div class="progress mb-2" style="height: 10px">
                    <div
                      id="uploadProgressBar"
                      class="progress-bar bg-primary progress-bar-striped progress-bar-animated"
                      role="progressbar"
                      style="width: 0%"
                      aria-valuenow="0"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                  <small id="uploadStatus" class="text-muted">
                    <i class="fas fa-clock me-1"></i>Preparando...
                  </small>
                </div>

                <!-- Progreso de transcripción -->
                <div
                  id="transcriptionProgress"
                  class="mb-4 progress-step"
                  style="display: none"
                >
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <span class="fw-bold text-success">
                      <span class="step-icon bg-success text-white">2</span>
                      Transcribiendo audios...
                    </span>
                    <span id="transcriptionPercent" class="badge bg-success"
                      >0%</span
                    >
                  </div>
                  <div class="progress mb-2" style="height: 10px">
                    <div
                      id="transcriptionProgressBar"
                      class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                      role="progressbar"
                      style="width: 0%"
                      aria-valuenow="0"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                  <small id="transcriptionStatus" class="text-muted">
                    <i class="fas fa-microphone-alt me-1"></i>Iniciando
                    transcripción...
                  </small>
                </div>

                <!-- Progreso general -->
                <div
                  id="overallProgress"
                  class="mb-3 progress-step"
                  style="display: none"
                >
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <span class="fw-bold text-info">
                      <i class="fas fa-tasks me-2"></i>Progreso general
                    </span>
                    <span id="overallPercent" class="badge bg-info">0%</span>
                  </div>
                  <div class="progress mb-2" style="height: 12px">
                    <div
                      id="overallProgressBar"
                      class="progress-bar bg-info progress-bar-striped progress-bar-animated"
                      role="progressbar"
                      style="width: 0%"
                      aria-valuenow="0"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                  <small id="overallStatus" class="text-muted">
                    <i class="fas fa-spinner fa-spin me-1"></i>Procesando...
                  </small>
                </div>

                <!-- Botón de cancelar -->
                <div
                  class="text-center mt-3"
                  id="cancelContainer"
                  style="display: none"
                >
                  <button
                    class="btn btn-danger"
                    id="cancelBtn"
                    onclick="cancelUpload()"
                  >
                    <i class="fas fa-times me-2"></i>Cancelar y Reiniciar
                  </button>
                </div>
              </div>

              <div class="loading-spinner mt-3">
                <div class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Procesando...</span>
                  </div>
                  <p class="mt-2">
                    Transcribiendo audios... Esto puede tomar unos minutos.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div id="results" class="mt-4"></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const results = document.getElementById("results");
      const loadingSpinner = document.querySelector(".loading-spinner");

      // Variable global para controlar la petición
      let currentUploadXHR = null;

      // Elementos de progreso
      const progressContainer = document.getElementById("progressContainer");
      const cancelContainer = document.getElementById("cancelContainer");
      const uploadProgress = document.getElementById("uploadProgress");
      const transcriptionProgress = document.getElementById(
        "transcriptionProgress"
      );
      const overallProgress = document.getElementById("overallProgress");

      const uploadProgressBar = document.getElementById("uploadProgressBar");
      const transcriptionProgressBar = document.getElementById(
        "transcriptionProgressBar"
      );
      const overallProgressBar = document.getElementById("overallProgressBar");

      const uploadPercent = document.getElementById("uploadPercent");
      const transcriptionPercent = document.getElementById(
        "transcriptionPercent"
      );
      const overallPercent = document.getElementById("overallPercent");

      const uploadStatus = document.getElementById("uploadStatus");
      const transcriptionStatus = document.getElementById(
        "transcriptionStatus"
      );
      const overallStatus = document.getElementById("overallStatus");

      // Eventos para drag and drop
      uploadArea.addEventListener("click", () => fileInput.click());
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });
      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });
      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        uploadFiles(files);
      });

      fileInput.addEventListener("change", (e) => {
        uploadFiles(e.target.files);
      });

      function uploadFiles(files) {
        if (files.length === 0) return;

        // Resetear interface
        results.innerHTML = "";
        loadingSpinner.style.display = "none";

        // Mostrar contenedor de progreso con animación
        progressContainer.style.display = "block";
        cancelContainer.style.display = "block"; // Mostrar botón de cancelar
        uploadProgress.style.display = "block";
        uploadProgress.classList.add("active");
        transcriptionProgress.style.display = "none";
        overallProgress.style.display = "block";
        overallProgress.classList.add("active");

        // Resetear barras de progreso
        updateProgressBar(uploadProgressBar, uploadPercent, 0);
        updateProgressBar(transcriptionProgressBar, transcriptionPercent, 0);
        updateProgressBar(overallProgressBar, overallPercent, 0);

        uploadStatus.innerHTML = `<i class="fas fa-upload me-1"></i>Preparando ${files.length} archivo(s)...`;
        overallStatus.innerHTML = `<i class="fas fa-play me-1"></i>Iniciando proceso...`;

        const formData = new FormData();
        for (let file of files) {
          formData.append("files[]", file);
        }

        currentUploadXHR = new XMLHttpRequest(); // Asignar a variable global

        // Progreso real de subida
        currentUploadXHR.upload.addEventListener("progress", function (e) {
          if (e.lengthComputable) {
            const percentComplete = Math.round((e.loaded / e.total) * 100);
            updateProgressBar(
              uploadProgressBar,
              uploadPercent,
              percentComplete
            );
            uploadStatus.innerHTML = `<i class="fas fa-upload me-1"></i>Subiendo... ${formatBytes(
              e.loaded
            )} / ${formatBytes(e.total)}`;
            updateProgressBar(
              overallProgressBar,
              overallPercent,
              Math.round(percentComplete * 0.3)
            ); // 30% del proceso total
            overallStatus.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>Subiendo archivos (${percentComplete}%)...`;
          }
        });

        currentUploadXHR.onload = function () {
          if (currentUploadXHR.status === 200) {
            // Subida completada
            updateProgressBar(uploadProgressBar, uploadPercent, 100);
            uploadStatus.innerHTML = `<i class="fas fa-check-circle me-1 text-success"></i>Subida completada`;

            // Activar paso de transcripción
            setTimeout(() => {
              transcriptionProgress.style.display = "block";
              transcriptionProgress.classList.add("active");
              transcriptionStatus.innerHTML = `<i class="fas fa-brain me-1"></i>Cargando modelo de IA...`;
              updateProgressBar(overallProgressBar, overallPercent, 35);
              overallStatus.innerHTML = `<i class="fas fa-microphone-alt me-1"></i>Iniciando transcripción...`;

              // Simular progreso de transcripción
              simulateTranscriptionProgress(files.length);
            }, 500);

            // Procesar respuesta
            const data = JSON.parse(currentUploadXHR.responseText);

            // Completar proceso después de la simulación
            setTimeout(() => {
              updateProgressBar(
                transcriptionProgressBar,
                transcriptionPercent,
                100
              );
              updateProgressBar(overallProgressBar, overallPercent, 100);
              transcriptionStatus.innerHTML = `<i class="fas fa-check-circle me-1 text-success"></i>Transcripción completada`;
              overallStatus.innerHTML = `<i class="fas fa-check-circle me-1 text-success"></i>¡Proceso completado exitosamente!`;

              // Ocultar botón de cancelar al completar
              cancelContainer.style.display = "none";

              // Mostrar resultados después de un momento
              setTimeout(() => {
                progressContainer.style.display = "none";
                displayResults(data.results);
                showSuccessToast(data.results.length);
                currentUploadXHR = null; // Limpiar referencia
              }, 2000);
            }, getTranscriptionTime(files.length));
          } else {
            handleError("Error en la subida del archivo");
          }
        };

        currentUploadXHR.onerror = function () {
          handleError("Error de conexión durante la subida");
        };

        currentUploadXHR.open("POST", "/upload");
        currentUploadXHR.send(formData);
      }

      function updateProgressBar(progressBar, percentElement, percent) {
        progressBar.style.width = percent + "%";
        progressBar.setAttribute("aria-valuenow", percent);
        percentElement.textContent = percent + "%";
      }

      function simulateTranscriptionProgress(fileCount) {
        let progress = 0;
        const totalSteps = fileCount * 8; // 8 pasos por archivo
        const stepSize = 95 / totalSteps;
        let currentStep = 0;

        const steps = [
          "Cargando modelo de IA...",
          "Analizando formato de audio...",
          "Procesando señal de audio...",
          "Detectando idioma...",
          "Transcribiendo contenido...",
          "Aplicando correcciones...",
          "Analizando calidad de servicio...",
          "Generando métricas...",
        ];

        const interval = setInterval(() => {
          if (currentStep >= totalSteps) {
            clearInterval(interval);
            return;
          }

          progress += stepSize + Math.random() * 3;
          currentStep++;

          updateProgressBar(
            transcriptionProgressBar,
            transcriptionPercent,
            Math.min(progress, 95)
          );
          updateProgressBar(
            overallProgressBar,
            overallPercent,
            35 + Math.min(progress, 95) * 0.65
          ); // 65% del proceso total

          // Actualizar estado basado en el paso actual
          const stepText = steps[currentStep % steps.length];
          transcriptionStatus.innerHTML = `<i class="fas fa-cog fa-spin me-1"></i>${stepText}`;
          overallStatus.innerHTML = `<i class="fas fa-microphone-alt me-1"></i>Transcribiendo (${Math.round(
            progress
          )}%)...`;
        }, 600 + Math.random() * 400); // Velocidad variable para mayor realismo
      }

      function getTranscriptionTime(fileCount) {
        // Tiempo base + tiempo por archivo (más realista)
        return 2000 + fileCount * 1500;
      }

      function formatBytes(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function showSuccessToast(fileCount) {
        const toast = document.createElement("div");
        toast.className = "toast position-fixed top-0 end-0 m-3";
        toast.innerHTML = `
          <div class="toast-body bg-success text-white d-flex align-items-center">
            <i class="fas fa-check-circle me-2"></i>
            ¡${fileCount} archivo(s) transcrito(s) exitosamente!
          </div>
        `;
        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        setTimeout(() => toast.remove(), 4000);
      }

      function handleError(message) {
        progressContainer.style.display = "none";
        cancelContainer.style.display = "none"; // Ocultar botón de cancelar
        loadingSpinner.style.display = "none";
        currentUploadXHR = null; // Limpiar referencia
        results.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
          </div>
        `;
      }
      function displayResults(resultsList) {
        results.innerHTML = "";

        resultsList.forEach((result) => {
          if (result.success) {
            const analysis = result.analysis;
            const perf = analysis.performance || {};
            const card = document.createElement("div");
            card.className = "card result-card";

            // Función para obtener color basado en score
            const getScoreColor = (score) => {
              if (score >= 80) return "success";
              if (score >= 60) return "warning";
              return "danger";
            };

            // Función para obtener icono de tono
            const getToneIcon = (tone) => {
              const icons = {
                amable: "fa-smile",
                empatico: "fa-heart",
                profesional: "fa-briefcase",
                cortado: "fa-user-slash",
                frustrado: "fa-frown",
                agresivo: "fa-angry",
                neutral: "fa-meh",
              };
              return icons[tone] || "fa-meh";
            };

            card.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-file-audio me-2"></i>${
                              result.filename
                            }</h6>
                            <div>
                                <span class="badge bg-${getScoreColor(
                                  perf.overall_score || 0
                                )}">${Math.round(
              perf.overall_score || 0
            )}%</span>
                                <span class="badge bg-success">Transcrito</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Scores de Performance -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6><i class="fas fa-chart-line me-2"></i>Evaluación de Performance</h6>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="progress mb-2" style="height: 20px;">
                                            <div class="progress-bar bg-${getScoreColor(
                                              perf.protocol_score || 0
                                            )}" 
                                                 style="width: ${
                                                   perf.protocol_score || 0
                                                 }%">
                                                ${Math.round(
                                                  perf.protocol_score || 0
                                                )}%
                                            </div>
                                        </div>
                                        <small class="text-muted">Protocolo</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="progress mb-2" style="height: 20px;">
                                            <div class="progress-bar bg-${getScoreColor(
                                              perf.tone_score || 0
                                            )}" 
                                                 style="width: ${
                                                   perf.tone_score || 0
                                                 }%">
                                                ${Math.round(
                                                  perf.tone_score || 0
                                                )}%
                                            </div>
                                        </div>
                                        <small class="text-muted">Tono</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="progress mb-2" style="height: 20px;">
                                            <div class="progress-bar bg-${getScoreColor(
                                              perf.resolution_score || 0
                                            )}" 
                                                 style="width: ${
                                                   perf.resolution_score || 0
                                                 }%">
                                                ${Math.round(
                                                  perf.resolution_score || 0
                                                )}%
                                            </div>
                                        </div>
                                        <small class="text-muted">Resolución</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="progress mb-2" style="height: 20px;">
                                            <div class="progress-bar bg-${getScoreColor(
                                              perf.overall_score || 0
                                            )}" 
                                                 style="width: ${
                                                   perf.overall_score || 0
                                                 }%">
                                                ${Math.round(
                                                  perf.overall_score || 0
                                                )}%
                                            </div>
                                        </div>
                                        <small class="text-muted">General</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Análisis de Protocolo -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-clipboard-check me-2"></i>Cumplimiento de Protocolo</h6>
                                    <div class="d-flex flex-wrap gap-1">
                                        ${Object.entries(
                                          perf.protocol_analysis || {}
                                        )
                                          .map(([key, value]) => {
                                            const labels = {
                                              saludo_inicial: "Saludo inicial",
                                              identificacion: "Identificación",
                                              pregunta_ayuda:
                                                "Pregunta de ayuda",
                                              despedida: "Despedida",
                                            };
                                            return `<span class="badge bg-${
                                              value ? "success" : "danger"
                                            }">${labels[key] || key}: ${
                                              value ? "✓" : "✗"
                                            }</span>`;
                                          })
                                          .join("")}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-user-tie me-2"></i>Análisis de Tono</h6>
                                    <div class="d-flex align-items-center">
                                        <i class="fas ${getToneIcon(
                                          perf.tone_analysis?.primary_tone
                                        )} me-2 text-primary"></i>
                                        <span class="badge bg-primary me-2">${
                                          perf.tone_analysis?.primary_tone ||
                                          "No detectado"
                                        }</span>
                                        ${
                                          perf.tone_analysis?.indicators
                                            ? Object.entries(
                                                perf.tone_analysis.indicators
                                              )
                                                .map(
                                                  ([tone, count]) =>
                                                    `<span class="badge bg-light text-dark me-1">${tone}: ${count}</span>`
                                                )
                                                .join("")
                                            : ""
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Resolución de Problemas -->
                            <div class="mb-3">
                                <h6><i class="fas fa-tools me-2"></i>Resolución de Problemas</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <span class="badge bg-${
                                          perf.problem_resolution?.resolved
                                            ? "success"
                                            : "danger"
                                        } me-2">
                                            ${
                                              perf.problem_resolution?.resolved
                                                ? "Problema Resuelto"
                                                : "Sin Resolución"
                                            }
                                        </span>
                                        ${
                                          perf.problem_resolution?.type
                                            ? `<span class="badge bg-info">Tipo: ${perf.problem_resolution.type}</span>`
                                            : ""
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        ${
                                          perf.problem_resolution
                                            ?.follow_up_needed
                                            ? '<span class="badge bg-warning">Requiere Seguimiento</span>'
                                            : ""
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Falencias Detectadas -->
                            ${
                              perf.falencias && perf.falencias.length > 0
                                ? `
                            <div class="mb-3">
                                <h6><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Falencias Detectadas</h6>
                                <div class="alert alert-warning">
                                    <ul class="mb-0">
                                        ${perf.falencias
                                          .map(
                                            (falencia) => `<li>${falencia}</li>`
                                          )
                                          .join("")}
                                    </ul>
                                </div>
                            </div>
                            `
                                : ""
                            }

                            <!-- Puntos de Mejora -->
                            ${
                              perf.puntos_mejora &&
                              perf.puntos_mejora.length > 0
                                ? `
                            <div class="mb-3">
                                <h6><i class="fas fa-lightbulb me-2 text-primary"></i>Puntos de Mejora</h6>
                                <div class="alert alert-info">
                                    <ul class="mb-0">
                                        ${perf.puntos_mejora
                                          .map((punto) => `<li>${punto}</li>`)
                                          .join("")}
                                    </ul>
                                </div>
                            </div>
                            `
                                : ""
                            }

                            <!-- Estadísticas básicas -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h5 class="text-primary">${
                                          analysis.word_count
                                        }</h5>
                                        <small class="text-muted">Palabras</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h5 class="text-primary">${
                                          Math.round(
                                            analysis.estimated_duration * 10
                                          ) / 10
                                        } min</h5>
                                        <small class="text-muted">Duración estimada</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h5 class="text-primary">${
                                          analysis.character_count
                                        }</h5>
                                        <small class="text-muted">Caracteres</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Transcripción -->
                            <div class="mb-3">
                                <h6><i class="fas fa-file-text me-2"></i>Transcripción:</h6>
                                <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                                    ${result.transcription}
                                </div>
                            </div>
                            
                            <div class="text-end">
                                <button class="btn btn-sm btn-outline-primary" onclick="copyTranscription('${
                                  result.transcription
                                }')">
                                    <i class="fas fa-copy me-1"></i>Copiar
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="copyForChatGPT('${
                                  result.file_id
                                }', '${result.filename}')">
                                    <i class="fas fa-robot me-1"></i>Copiar para ChatGPT
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="downloadAnalysis('${
                                  result.file_id
                                }', '${result.filename}')">
                                    <i class="fas fa-chart-bar me-1"></i>Descargar Análisis
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="downloadTranscription('${
                                  result.file_id
                                }', '${result.filename}')">
                                    <i class="fas fa-download me-1"></i>Descargar
                                </button>
                            </div>
                        </div>
                    `;
            results.appendChild(card);
          } else {
            const errorCard = document.createElement("div");
            errorCard.className = "alert alert-danger";
            errorCard.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>${result.filename}:</strong> ${result.error}
                    `;
            results.appendChild(errorCard);
          }
        });
      }

      function copyTranscription(text) {
        navigator.clipboard.writeText(text).then(() => {
          // Mostrar confirmación
          const toast = document.createElement("div");
          toast.className = "toast position-fixed bottom-0 end-0 m-3";
          toast.innerHTML = `
                    <div class="toast-body bg-success text-white">
                        <i class="fas fa-check me-2"></i>Transcripción copiada al portapapeles
                    </div>
                `;
          document.body.appendChild(toast);
          const bsToast = new bootstrap.Toast(toast);
          bsToast.show();
          setTimeout(() => toast.remove(), 3000);
        });
      }

      function downloadTranscription(fileId, filename) {
        fetch(`/transcription/${fileId}`)
          .then((response) => response.json())
          .then((data) => {
            const blob = new Blob([JSON.stringify(data, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `transcripcion_${filename.split(".")[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
          });
      }

      function downloadAnalysis(fileId, filename) {
        fetch(`/transcription/${fileId}`)
          .then((response) => response.json())
          .then((data) => {
            // Crear reporte detallado de análisis
            const report = {
              archivo: filename,
              fecha_analisis: new Date().toISOString(),
              transcripcion: data.transcription,
              analisis_performance: data.analysis.performance,
              metricas_basicas: {
                palabras: data.analysis.word_count,
                caracteres: data.analysis.character_count,
                duracion_estimada: data.analysis.estimated_duration,
              },
              resumen_ejecutivo: {
                score_general: data.analysis.performance?.overall_score || 0,
                protocolo_cumplido:
                  data.analysis.performance?.protocol_score || 0,
                calidad_tono: data.analysis.performance?.tone_score || 0,
                resolucion_efectiva:
                  data.analysis.performance?.resolution_score || 0,
                problema_resuelto:
                  data.analysis.performance?.problem_resolution?.resolved ||
                  false,
              },
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `analisis_performance_${filename.split(".")[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
          });
      }

      // Función para cancelar la subida y reiniciar
      function cancelUpload() {
        if (
          currentUploadXHR &&
          currentUploadXHR.readyState !== XMLHttpRequest.DONE
        ) {
          currentUploadXHR.abort();
          currentUploadXHR = null;
        }

        // Resetear toda la interfaz
        progressContainer.style.display = "none";
        cancelContainer.style.display = "none";
        loadingSpinner.style.display = "none";
        results.innerHTML = "";

        // Resetear el input de archivos
        fileInput.value = "";

        // Mostrar mensaje de cancelación
        const toast = document.createElement("div");
        toast.className = "toast position-fixed bottom-0 end-0 m-3";
        toast.innerHTML = `
          <div class="toast-body bg-warning text-white">
            <i class="fas fa-times-circle me-2"></i>Proceso cancelado. Puedes subir nuevos archivos.
          </div>
        `;
        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        setTimeout(() => toast.remove(), 3000);
      }

      // Función para copiar transcripción formateada para ChatGPT
      function copyForChatGPT(fileId, filename) {
        fetch(`/transcription/${fileId}`)
          .then((response) => response.json())
          .then((data) => {
            const analysis = data.analysis;
            const perf = analysis.performance || {};

            // Crear un prompt estructurado para ChatGPT
            const chatGPTPrompt = `🎯 ANÁLISIS DE LLAMADA DE ATENCIÓN AL CLIENTE 

📁 ARCHIVO: ${filename}
📅 FECHA: ${new Date().toLocaleDateString("es-ES")}

📊 SCORES ACTUALES:
• Protocolo: ${Math.round(perf.protocol_score || 0)}%
• Tono: ${Math.round(perf.tone_score || 0)}%
• Resolución: ${Math.round(perf.resolution_score || 0)}%
• General: ${Math.round(perf.overall_score || 0)}%

✅ PROTOCOLO CUMPLIDO:
${Object.entries(perf.protocol_analysis || {})
  .map(([key, value]) => {
    const labels = {
      saludo_inicial: "Saludo inicial",
      identificacion: "Identificación",
      pregunta_ayuda: "Pregunta de ayuda",
      despedida: "Despedida",
    };
    return `• ${labels[key] || key}: ${value ? "✓ SÍ" : "✗ NO"}`;
  })
  .join("\n")}

🎭 ANÁLISIS DE TONO:
• Tono principal detectado: ${
              perf.tone_analysis?.primary_tone || "No detectado"
            }
${
  perf.tone_analysis?.indicators
    ? Object.entries(perf.tone_analysis.indicators)
        .map(([tone, count]) => `• ${tone}: ${count} menciones`)
        .join("\n")
    : ""
}

🔧 RESOLUCIÓN DE PROBLEMAS:
• ¿Problema resuelto?: ${perf.problem_resolution?.resolved ? "✓ SÍ" : "✗ NO"}
${
  perf.problem_resolution?.type
    ? `• Tipo de problema: ${perf.problem_resolution.type}`
    : ""
}
${perf.problem_resolution?.follow_up_needed ? "• ⚠️ Requiere seguimiento" : ""}

⚠️ FALENCIAS DETECTADAS:
${
  perf.falencias && perf.falencias.length > 0
    ? perf.falencias.map((falencia) => `• ${falencia}`).join("\n")
    : "• No se detectaron falencias críticas"
}

💡 PUNTOS DE MEJORA SUGERIDOS:
${
  perf.puntos_mejora && perf.puntos_mejora.length > 0
    ? perf.puntos_mejora.map((punto) => `• ${punto}`).join("\n")
    : "• Se requiere análisis más detallado"
}

📝 TRANSCRIPCIÓN COMPLETA:
"${data.transcription}"

🤖 SOLICITUD PARA CHATGPT:
Por favor analiza esta llamada de atención al cliente  y proporciona:

1. Un análisis más profundo del desempeño del asesor
2. Recomendaciones específicas para mejorar la atención
3. Evaluación de la satisfacción del cliente
4. Sugerencias de entrenamiento o coaching
5. Puntos positivos que el asesor debería mantener
6. Una calificación general del 1-10 con justificación

Contexto: queremos mejorar la calidad de nuestro servicio al cliente.`;

            // Copiar al portapapeles
            navigator.clipboard
              .writeText(chatGPTPrompt)
              .then(() => {
                // Mostrar confirmación con instrucciones
                const toast = document.createElement("div");
                toast.className = "toast position-fixed bottom-0 end-0 m-3";
                toast.style.minWidth = "350px";
                toast.innerHTML = `
                <div class="toast-body bg-success text-white">
                  <div class="d-flex align-items-start">
                    <i class="fas fa-robot me-2 mt-1"></i>
                    <div>
                      <strong>¡Copiado para ChatGPT!</strong><br>
                      <small>Ve a ChatGPT y pega el contenido (Ctrl+V). El prompt está optimizado para obtener un análisis profesional completo.</small>
                    </div>
                  </div>
                  <hr class="my-2">
                  <div class="d-flex gap-2">
                    <a href="https://chat.openai.com" target="_blank" class="btn btn-sm btn-light">
                      <i class="fas fa-external-link-alt me-1"></i>Abrir ChatGPT
                    </a>
                    <a href="https://claude.ai" target="_blank" class="btn btn-sm btn-light">
                      <i class="fas fa-external-link-alt me-1"></i>Abrir Claude
                    </a>
                  </div>
                </div>
              `;
                document.body.appendChild(toast);
                const bsToast = new bootstrap.Toast(toast, { delay: 8000 });
                bsToast.show();
                setTimeout(() => toast.remove(), 8500);
              })
              .catch(() => {
                // Si falla el copiado, mostrar el texto en un modal
                showChatGPTModal(chatGPTPrompt);
              });
          });
      }

      // Función para mostrar modal con el prompt si falla el copiado
      function showChatGPTModal(promptText) {
        const modal = document.createElement("div");
        modal.className = "modal fade";
        modal.innerHTML = `
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="fas fa-robot me-2"></i>Prompt para ChatGPT
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p class="text-muted">Copia este texto y pégalo en ChatGPT para obtener un análisis detallado:</p>
                <textarea class="form-control" rows="15" readonly style="font-size: 12px;">${promptText}</textarea>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="copyModalText()">
                  <i class="fas fa-copy me-1"></i>Copiar Texto
                </button>
                <a href="https://chat.openai.com" target="_blank" class="btn btn-success">
                  <i class="fas fa-external-link-alt me-1"></i>Abrir ChatGPT
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        // Remover modal al cerrarse
        modal.addEventListener("hidden.bs.modal", () => {
          modal.remove();
        });
      }

      // Función auxiliar para copiar texto del modal
      function copyModalText() {
        const textarea = document.querySelector(".modal textarea");
        textarea.select();
        document.execCommand("copy");

        const toast = document.createElement("div");
        toast.className = "toast position-fixed bottom-0 end-0 m-3";
        toast.innerHTML = `
          <div class="toast-body bg-success text-white">
            <i class="fas fa-check me-2"></i>Texto copiado al portapapeles
          </div>
        `;
        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        setTimeout(() => toast.remove(), 3000);
      }
    </script>
  </body>
</html>
